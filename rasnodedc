import rclpy
from rclpy.node import Node
from std_msgs.msg import String
import lgpio

# 핀 번호 설정
IN_A1 = 17
IN_B1 = 27
PWM1 = 18
EN_DIAG1 = 22

IN_A2 = 23
IN_B2 = 24
PWM2 = 25
EN_DIAG2 = 5

class MotorController(Node):
    def __init__(self):
        super().__init__('motor_controller')
        self.subscription = self.create_subscription(
            String,
            'motor_command',
            self.listener_callback,
            10)
        self.subscription  # prevent unused variable warning

        # GPIO 핀 핸들러 열기
        self.chip = lgpio.gpiochip_open(0)

        # GPIO 핀 설정
        lgpio.gpio_claim_output(self.chip, IN_A1, 0)
        lgpio.gpio_claim_output(self.chip, IN_B1, 0)
        lgpio.gpio_claim_output(self.chip, PWM1, 0)
        lgpio.gpio_claim_output(self.chip, EN_DIAG1, 0)

        lgpio.gpio_claim_output(self.chip, IN_A2, 0)
        lgpio.gpio_claim_output(self.chip, IN_B2, 0)
        lgpio.gpio_claim_output(self.chip, PWM2, 0)
        lgpio.gpio_claim_output(self.chip, EN_DIAG2, 0)

        # 모터 드라이버 활성화
        lgpio.gpio_write(self.chip, EN_DIAG1, 1)
        lgpio.gpio_write(self.chip, EN_DIAG2, 1)

        # PWM 설정
        # lgpio는 직접 PWM 제어를 지원하지 않으므로 외부 PWM 라이브러리 필요
        # 여기서는 PWM 핀을 HIGH 상태로 설정
        lgpio.gpio_write(self.chip, PWM1, 1)
        lgpio.gpio_write(self.chip, PWM2, 1)

    def listener_callback(self, msg):
        command = msg.data.split()
        motor = int(command[0])
        direction = command[1]
        speed = int(command[2])

        if motor == 1:
            if direction == 'forward':
                lgpio.gpio_write(self.chip, IN_A1, 1)
                lgpio.gpio_write(self.chip, IN_B1, 0)
            elif direction == 'backward':
                lgpio.gpio_write(self.chip, IN_A1, 0)
                lgpio.gpio_write(self.chip, IN_B1, 1)
            # 속도 조절은 PWM 설정을 외부 라이브러리 또는 하드웨어로 해야 합니다

        elif motor == 2:
            if direction == 'forward':
                lgpio.gpio_write(self.chip, IN_A2, 1)
                lgpio.gpio_write(self.chip, IN_B2, 0)
            elif direction == 'backward':
                lgpio.gpio_write(self.chip, IN_A2, 0)
                lgpio.gpio_write(self.chip, IN_B2, 1)
            # 속도 조절은 PWM 설정을 외부 라이브러리 또는 하드웨어로 해야 합니다

    def destroy_node(self):
        super().destroy_node()
        # 핀 핸들러 닫기
        lgpio.gpiochip_close(self.chip)


def main(args=None):
    rclpy.init(args=args)
    motor_controller = MotorController()

    try:
        rclpy.spin(motor_controller)
    except KeyboardInterrupt:
        pass

    motor_controller.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
